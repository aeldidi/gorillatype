<!DOCTYPE html>

<head>
    <style>
        html {
            font-family: monospace;
            max-width: 1000px;
            margin: 0 auto
        }

        p {
            font-size: 16px
        }

        h1 {
            font-size: 20px
        }

        .cursor {
            animation: blink 1s steps(1, end) infinite;
            border-left: 1px solid rgba(0, 0, 0, 0)
        }

        @keyframes blink {
            0% {
                border-left: 1px solid black;
            }

            50% {
                border-left: 1px solid rgba(0, 0, 0, 0);
            }
        }

        .red-outline {
            border: 1px solid red;
        }

        #typing-area {
            font-size: 20px;
            margin: 2em;
            min-width: 75vw;
            display: block;
            user-select: none;
        }

        #typing-area * {
            display: inline-block;
            padding-right: 0.05em;
            min-width: 5px;
            min-height: 1ch;
            border-left: 1px solid rgba(0, 0, 0, 0);
        }

        .not-typed {
            color: #707070;
        }

        .typed {
            color: #000000;
        }
    </style>

    <script>
        let all_red = false

        function toggle_red() {
            if (all_red) {
                all_red = false
                const divs = document.querySelectorAll('*')
                for (const div of divs) {
                    div.classList.remove('red-outline')
                }
                return
            }

            const divs = document.querySelectorAll('*')
            for (const div of divs) {
                div.classList.add('red-outline')
            }
            all_red = true
        }

        // The list of words to type
        // TODO: get this from some list or something
        let words = [
            'Hi', 'there,', 'I', 'am', 'a', 'monkey.',
            'Ooh', 'ooh', 'ah', 'ah.'
        ]

        let word_divs = []

        function main() {
            const div = document.querySelector('#typing-area')
            const typing_area = document.createElement('div')
            typing_area.id = 'typing-area'

            for (const word of words) {
                if (word == '' || word == '\n') {
                    continue
                }
                for (const letter of word) {
                    const letter_div = document.createElement('div')
                    letter_div.classList.add('letter', 'not-typed')
                    letter_div.textContent = `${letter}`
                    typing_area.appendChild(letter_div)
                }

                const space = document.createElement('div')
                space.classList.add('letter', 'not-typed')
                space.innerHTML = '&nbsp;'
                typing_area.appendChild(space)
            }

            typing_area.firstElementChild.classList.add('cursor')
            div.replaceWith(typing_area)

            let children = [...typing_area.children].
                filter(e => e.classList.contains('letter'))
            let index = 0

            // 'keypress' only handles events which have a character associated
            // with them, which backspace doesn't
            window.addEventListener('keydown', function (e) {
                if (index == 0 || e.key != 'Backspace') {
                    return
                }

                children[index].classList.remove('cursor')
                children[index - 1].classList.add('cursor', 'not-typed')
                index -= 1
            })

            window.addEventListener('keypress', function (e) {
                if (done_typing) {
                    return
                }

                if (!began_typing) {
                    console.log('started')
                    start_time = Date.now()
                    began_typing = true
                }

                // The person is finished typing
                if (index >= children.length - 1) {
                    console.log('done')
                    done_typing = true
                    display_end_message()
                    return
                }

                let key = e.key
                const current = children[index]

                // We use &nbsp; for the spaces, which is actually a
                // nonbreaking space.
                if (key == ' ') {
                    key = '\xa0'
                }

                if (key != '\xa0' && !e.shiftKey) {
                    key = key.toLocaleLowerCase()
                }

                // Incorrect letter typed.
                if (key != children[index].textContent) {
                    return
                }

                index += 1
                current.classList.remove('not-typed', 'cursor')
                children[index].classList.add('cursor')
                // The person is finished typing
                if (index >= children.length - 1) {
                    console.log('done')
                    done_typing = true
                    display_end_message()
                    return
                }
            })
        }

        var start_time = 0
        var began_typing = false
        var done_typing = false

        function display_end_message() {
            const time_ms = Date.now() - start_time
            const time_sec = time_ms / 1000
            const time_min = time_ms / 60000

            const wpm = document.createElement('p')
            wpm.innerHTML = `
                <strong><abbr title="Words Per Minute">WPM</abbr>:</strong>
                ${words.length / time_min}
            `
            const time = document.createElement('p')
            time.innerHTML = `<strong>Time:</strong> ${time_sec}s`

            console.log(words.flat())
            const characters = document.createElement('p')
            characters.innerHTML = `
                <strong>Characters Typed:</strong> ${words.flat().length}
            `

            const results = document.createElement('div')
            results.append(wpm, time, characters)

            const typing_area = document.querySelector('#typing-area')
            typing_area.replaceWith(results)

            const msg = document.createElement('p')
            msg.innerHTML = `
                <p>
                    Thanks for using GorillaType, refresh the page if you want
                    to do another test.
                </p>
                <strong>Your results:</strong>
            `
            const instructions = document.querySelector('#instructions')
            instructions.replaceWith(msg)
        }

        window.onload = main
    </script>
</head>

<body>
    <h1>GorillaType</h1>
    <p id="instructions">
        <strong>Instructions:</strong> Type out the text below as fast as
        you can. When you're done, we'll tell you your typing speed.

        Timing starts when you begin typing.
    </p>
    <noscript id="typing-area">
        This website makes use of Javascript for the entire game, meaning it
        can't work without it.

        The Javascript on this page didn't run, which either means your browser
        doesn't support Javascript, or you have it disabled.

        If you have Javascript disabled and decide to re-enable it, make sure
        to reload the page before doing it.
    </noscript>
    <p>To get a new paragraph to type, refresh the page.</p>

    <button id="toggle-red" onclick="toggle_red()">Toggle Red Outlines (Useful for Debugging)</button>

    <template id="end-message">
        <div class="end-box">
            <p><strong><abbr title="Words Per Minute">WPM</abbr>:</strong> </p>
        </div>
    </template>
</body>